# p-net Profinet device stack

This is fork of the p-net stack from rt-labs. See original docs below.

* Source repository: [https://github.com/rtlabs-com/p-net](https://github.com/rtlabs-com/p-net)
* Documentation: [https://rt-labs.com/docs/p-net](https://rt-labs.com/docs/p-net)
* Continuous integration: [https://github.com/rtlabs-com/p-net/actions](https://github.com/rtlabs-com/p-net/actions)
* RT-Labs (stack integration, certification services and training): [https://rt-labs.com](https://rt-labs.com)

## Converting examples for your own usage

1. Create a new GSDML file with the [GSDML creator](https://github.com/InspireHornets/gsdml-creator)
2. Add the GSDML file to the `samples/{pn_my_app}` folder. It is not used by the app, but is only used for reference.
1. Duplicate the `samples/setpoint_interface` folder and content and rename the `setpoint_interface` folder, for example to `pn_my_app`
2. Open the `CMakeLists.txt` in your `pn_my_app` folder and rename all `setpoint_interface` to `pn_my_app`
3. Open `app_gsdml.h` and add the sizes and (sub)module IDs of the modules you added. The latter are also generated by the GSDML creator.
4. In `app_gsdml.c`:
   1. Copy the `static const app_gsdml_module_t` and `static const app_gsdml_submodule_t` from the `app_gdsml.c` file from the GSDML creator to the `app_gsdml.c` file of your app.
   1. Add the modules and submodules to the supported lists: `app_gsdml_modules[]` and `app_gsdml_submodules[]`
5. Open `app_data.c`:
   1. add a static struct where in/output data can be stored into.
      - `static uint8_t inputdata[APP_GSDML_INPUT_DATA_DIGITAL_SIZE] = {0};`
      - Floats are saved as unsigned integers, because of endian conversion. Profinet data has [network endianess](https://en.wikipedia.org/wiki/Endianness#Networking) (Big endian), whereas C uses little endian?
   1. Add a `typedef struct` to store I/O data
   2. Add the modules you added to the if statement in `app_data_from_plc`, identified by their submodule number
   3. Add the modules you added to `app_data_to_plc`, identified by their submodule number
   4. (Optional) if you added a module parameter add the parameter to `app_data_write_parameter`, identified by their parameter index

Endianess = The attribute of a system that indicates whether integers are represented with the most significant byte stored at the lowest address (big endian) or at the highest address (little endian)

## Tip

The app log level can be adjusted by the number of `v`'s as the argument when you call the app. For example:
`sudo setpoint_interface -vvv` to see error, warning and info log messages in the console.

The log level of p-net can be adjusted by changing `LOG_LEVEL_DEBUG` in `#define LOG_LEVEL (LOG_LEVEL_DEBUG)` in
`/home/robotvm/profinet-fork/p-net/cmake-build-debug/src/options.h`

## Issues

- In case you see the following error message while connecting

    ```
    Event indication PNET_EVENT_ABORT   AREP: 1
        Error class: 0x00 Not decoded
        Error code:  0x00 Not decoded
    Connection closed
    Waiting for PLC connect request
    ```

    try to restart the VM. There seems to be a older instance still running in the background.
- If you change the dns name of your profinet device, you might need to reset the ethernet adapters settings with `sudo my_pn_app -i ens192 -f`,
   where `-i` is the interface name and `-f` is the flag to reset to the factory settings.
-
